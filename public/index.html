<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CentralServer Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f4f6f8; }
        h1 { color: #333; margin-bottom: 20px; }
        
        .status-bar { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .indicator.on { background: #2ecc71; }
        .indicator.off { background: #e74c3c; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #555; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #fafafa; }

        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-accept { background: #E3FCEF; color: #006644; }
        .btn-reject { background: #FFEBE6; color: #BF2600; }
        .btn-notify { background: #DEEBFF; color: #0747A6; }

        .meta { font-size: 12px; color: #777; margin-top: 4px; }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Central Admin Dashboard</h1>
    
    <div class="status-bar">
        <div id="status-ind" class="indicator off"></div>
        <span id="status-text">Disconnected</span>
    </div>

    <div id="clubs-section" style="display:none; margin-bottom: 30px;">
        <h2>üè¢ Registered Clubs</h2>
        <table>
            <thead>
                <tr>
                    <th>Club Name</th>
                    <th>Club ID</th>
                    <th>Club Secret</th>
                </tr>
            </thead>
            <tbody id="clubs-body">
                <!-- Clubs will render here -->
            </tbody>
        </table>
    </div>

    <div id="requests-section" style="display:none; margin-bottom: 30px;">
        <h2>üìù Pending Club Requests</h2>
        <table>
            <thead>
                <tr>
                    <th>Club Name</th>
                    <th>Creator</th>
                    <th>Secret</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="requests-body">
                <!-- Requests will render here -->
            </tbody>
        </table>
    </div>

    <h2>üìÖ Live Events</h2>
    <table>
        <thead>
            <tr>
                <th>Club</th>
                <th>Event</th>
                <th>Venue</th>
                <th>Details</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="events-body">
            <!-- Events will render here -->
        </tbody>
    </table>

    <script>
        const WS_URL = 'ws://' + window.location.host;
        const ADMIN_SECRET = 'admin_secret_123';
        
        const statusInd = document.getElementById('status-ind');
        const statusText = document.getElementById('status-text');
        const clubsBody = document.getElementById('clubs-body');
        const clubsSection = document.getElementById('clubs-section');
        const eventsBody = document.getElementById('events-body');
        const requestsBody = document.getElementById('requests-body');
        const requestsSection = document.getElementById('requests-section');

        let socket;

        function connect() {
            socket = new WebSocket(WS_URL);

            socket.onopen = () => {
                statusInd.className = 'indicator on';
                statusText.textContent = 'Connected';
                
                // Handshake
                socket.send(JSON.stringify({ kind: 'admin_handshake', secret: ADMIN_SECRET }));
            };

            socket.onclose = () => {
                statusInd.className = 'indicator off';
                statusText.textContent = 'Disconnected - Reconnecting...';
                setTimeout(connect, 3000);
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log('Received:', msg);

                if (msg.kind === 'full_state') {
                    if (msg.clubs) renderClubs(msg.clubs);
                    renderEvents(msg.events);
                    if (msg.requests) {
                        renderRequests(msg.requests);
                    }
                }
            };
        }

        function renderClubs(clubs) {
            clubsBody.innerHTML = '';
            if (clubs && clubs.length > 0) {
                 clubsSection.style.display = 'block';
                 clubs.forEach(club => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${escapeHtml(club.club_name)}</strong></td>
                        <td><code>${escapeHtml(club.club_id)}</code></td>
                        <td><code style="color: #666;">${escapeHtml(club.club_secret)}</code></td>
                    `;
                    clubsBody.appendChild(tr);
                 });
            } else {
                 clubsSection.style.display = 'none';
            }
        }

        function renderEvents(events) {
            eventsBody.innerHTML = '';
            
            if (events.length === 0) {
                eventsBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">No active events found from connected clubs.</td></tr>';
                return;
            }

            // 1. Group by Date
            const grouped = {};
            events.forEach(evt => {
                if (!evt.event_timestamp) return;
                const d = new Date(evt.event_timestamp).toDateString(); // e.g., "Mon Dec 28 2025"
                if (!grouped[d]) grouped[d] = [];
                grouped[d].push(evt);
            });

            // 2. Sort Dates and Render
            Object.keys(grouped).sort((a,b) => new Date(a) - new Date(b)).forEach(dateStr => {
                // Header Row
                const headerTr = document.createElement('tr');
                headerTr.style.background = '#e2e8f0';
                headerTr.innerHTML = `<td colspan="5" style="font-weight:bold; color:#475569;">üìÖ ${dateStr}</td>`;
                eventsBody.appendChild(headerTr);

                // Sort events within the day by time
                const dayEvents = grouped[dateStr].sort((a,b) => a.event_timestamp - b.event_timestamp);

                // Check conflicts (within 15 mins = 900000 ms)
                dayEvents.forEach((evt, idx) => {
                    let isConflict = false;
                    const time = evt.event_timestamp;
                    
                    // Check prev
                    if (idx > 0) {
                        const prev = dayEvents[idx-1];
                        if (Math.abs(time - prev.event_timestamp) <= 900000) isConflict = true;
                    }
                    // Check next
                    if (idx < dayEvents.length - 1) {
                        const next = dayEvents[idx+1];
                        if (Math.abs(time - next.event_timestamp) <= 900000) isConflict = true;
                    }

                    const tr = document.createElement('tr');
                    if (isConflict) {
                        tr.style.background = '#fff1f2'; // light red bg
                    }

                    const timeStr = new Date(evt.event_timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    tr.innerHTML = `
                        <td>
                            <strong>${escapeHtml(evt.club_name)}</strong>
                            <div class="meta">ID: ${evt.club_id}</div>
                        </td>
                        <td>
                            <strong>${escapeHtml(evt.event_name || 'No Event')}</strong>
                            ${isConflict ? '<span style="background:#ef4444; color:white; padding:2px 6px; border-radius:4px; font-size:0.7em; margin-left:5px;">‚ö†Ô∏è CONFLICT</span>' : ''}
                            <div class="meta">ID: ${evt.event_id || '-'}</div>
                        </td>
                        <td>
                             <div style="font-weight:500; color:#475569;">üìç ${escapeHtml(evt.event_venue || 'TBD')}</div>
                        </td>
                        <td>
                            <div>${escapeHtml(evt.event_description || '')}</div>
                            <div class="meta">üïí ${timeStr}</div>
                        </td>
                        <td>
                            ${evt.event_id ? `
                                <button class="btn btn-accept" onclick="sendOp('EVENT_ACCEPTED', '${evt.club_id}', '${evt.event_id}')">Accept</button>
                                <button class="btn btn-reject" onclick="sendOp('EVENT_REJECTED', '${evt.club_id}', '${evt.event_id}')">Reject</button>
                                <button class="btn btn-notify" onclick="sendOp('EVENT_NOTIFICATION', '${evt.club_id}', '${evt.event_id}')">Notify</button>
                            ` : '<span style="color:#ccc">No Actions</span>'}
                        </td>
                    `;
                    eventsBody.appendChild(tr);
                });
            });

            // Handle events with no timestamp (optional, maybe put at bottom)
            const noDateEvents = events.filter(e => !e.event_timestamp);
            if (noDateEvents.length > 0) {
                const headerTr = document.createElement('tr');
                headerTr.style.background = '#e2e8f0';
                headerTr.innerHTML = `<td colspan="4" style="font-weight:bold; color:#475569;">Unscheduled / Invalid Date</td>`;
                eventsBody.appendChild(headerTr);
                
                noDateEvents.forEach(evt => {
                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td><strong>${escapeHtml(evt.club_name)}</strong></td>
                        <td>${escapeHtml(evt.event_name)}</td>
                        <td>${escapeHtml(evt.event_description)}</td>
                        <td>Unknown Date</td>
                     `;
                     eventsBody.appendChild(tr);
                });
            }
        }

        function renderRequests(requests) {
            requestsBody.innerHTML = '';
            if (requests && requests.length > 0) {
                requestsSection.style.display = 'block';
                requests.forEach(req => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${escapeHtml(req.club_name)}</td>
                        <td>${escapeHtml(req.creator_name)}</td>
                        <td><code>${escapeHtml(req.club_secret)}</code></td>
                        <td>
                            <button class="btn btn-accept" onclick="sendOp('APPROVE_CLUB', '${req.request_id}', 'req-event')">Approve</button>
                            <button class="btn btn-reject" onclick="sendOp('REJECT_CLUB', '${req.request_id}', 'req-event')">Reject</button>
                        </td>
                    `;
                    requestsBody.appendChild(tr);
                });
            } else {
                requestsSection.style.display = 'none';
            }
        }

        window.sendOp = (op, clubId, eventId) => {
            let defaultText = '';
            let promptMsg = `Enter message for ${op}:`;

            // Club Ops
            if (op === 'APPROVE_CLUB' || op === 'REJECT_CLUB') {
                 if (!confirm(`Are you sure you want to ${op === 'APPROVE_CLUB' ? 'APPROVE' : 'REJECT'} this club?`)) return;
                 socket.send(JSON.stringify({
                    kind: 'operation',
                    op: op,
                    club_id: clubId, 
                    event_id: eventId, 
                    message: ''
                 }));
                 console.log(`Sent ${op} for request ${clubId}`);
                 return;
            }

            if (op === 'EVENT_ACCEPTED') {
                defaultText = 'Approved!';
                promptMsg = 'Enter acceptance message (optional):';
            } else if (op === 'EVENT_REJECTED') {
                promptMsg = 'Enter reason for rejection (optional):';
            } else if (op === 'EVENT_NOTIFICATION') {
                promptMsg = 'Enter notification message (optional):';
            }

            const message = prompt(promptMsg, defaultText);
            if (message === null) return; // Cancelled

            socket.send(JSON.stringify({
                kind: 'operation',
                op: op,
                club_id: clubId,
                event_id: eventId,
                message: message
            }));
            
            console.log(`Sent ${op} to club.`);
        };

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        connect();
    </script>
</body>
</html>